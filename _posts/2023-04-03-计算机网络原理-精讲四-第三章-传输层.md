---
title: 计算机网络原理 精讲四 第三章 传输层
author: mumu
date: 2023-04-03 19:00:00 +0800
categories: [sunlands,计算机网络原理 精讲四 第三章 传输层]
tags: [sunlands,计算机网络原理]
pin: false

---

# 计算机网络原理 精讲四 第三章 传输层 [^1]

## 第一节 传输层的基本服务  

### 1.1. 传输层功能

#### 一、 传输层的核心任务： 

应用进程之间提供端到端的逻辑通信服务。

只有主机才有传输层； 网络核心中的路由器结点等只用到下三层的功能。

#### 二、 传输层的<font color='red' style='background-color:' size=''>功能</font>： （ <font color='red' style='background-color:' size=''>吩咐刘墉寻差错-可靠</font>）

1. 对应用层报文进行<font color='' style='background-color:#FFFF00' size=''>分</font>段和重组； 
2. 面向应用层实现<font color='' style='background-color:#FFFF00' size=''>复</font>用与分解
3. 实现端到端的<font color='' style='background-color:#FFFF00' size=''>流</font>量控制 
4. <font color='red' style='background-color:' size=''><font color='' style='background-color:#FFFF00' size=''>拥</font>塞控制</font>； 
5. 传输层<font color='red' style='background-color:' size=''>寻</font>址
6. 对报文进行<font color='red' style='background-color:' size=''>差错</font>检测； 
7. 实现进程间的端到端<font color='red' style='background-color:' size=''>可靠</font>数据传输控制  

### 1.2. 传输层寻址和端口

#### 一、 寻址

单个计算机中， 不同应用进程用<font color='' style='background-color:#FFFF00' size=''>进程标识符（ 进程 ID）</font> 来区分。 

在全网范围内利用“ <font color='red' style='background-color:' size=''>IP地址+端口号</font>” 唯一标识一个<font color='' style='background-color:#FFFF00' size=''>通信端点</font>。 应用层和传输层间抽象的协议端口是软件端口。

#### 二、 传输层端口号为 16 位整数， 可以编号 65536 个（ 2 的 16 次方）

| 0——1023      | 熟知端口号               |
| ------------ | ------------------------ |
| 1024——49151  | 登记端口号               |
| 49152——65535 | 客户端口号，或短暂端口号 |

1. 服务器端使用的端口号： 熟知端口号和登记端口号
2. 客户端使用的端口号： 临时性， 在客户进程运行是由操作系统随机选取唯一未被使用的端口号。
3. 端口号<font color='' style='background-color:#FFFF00' size=''>小于 256 的端口为常用端口  </font>

### 1.3. 无连接服务与面向连接服务  

| <font color='red' style='background-color:' size=''>无连接</font>服务 | <font color='red' style='background-color:' size=''>面向连接</font>服务 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 数据传输之前:<font color='red' style='background-color:' size=''>无需</font>与对端进行任何信 息交换，直接构造传输层报文段并向接 收端发送。 | 数据传输之前︰<font color='red' style='background-color:' size=''>需要</font>双方交换一些控制信 息，建立逻辑连接，然后再传输数据，传 输结束后还需要拆除连接 |
| 类似于信件通信                                               | 类似于电话通信                                               |

## 第二节 传输层的复用与分解  

### 2.1. 多路复用与多路分解

> 支持众多应用进程共用同一个传输层协议， 并能够将接收到的数据准确交付给不同的应用进程， 是传输层需要实现的一项基本功能， 称为传输层的<font color='' style='background-color:#FFFF00' size=''>多路复用与多路分解</font>(简称为<font color='' style='background-color:#FFFF00' size=''>复用与分解</font>， 也称为为<font color='' style='background-color:#FFFF00' size=''>复用与分用</font>)。

#### 一、 <font color='red' style='background-color:' size=''>多路复用</font>：

 在源主机， 传输层协议从不同的套接字收集应用进程发送的数据块， 并为每个数据块封装上首部信息（ 包括用于分解的信息） 构成报文段， 然后将报文段传递给网络层。

#### 二、 <font color='red' style='background-color:' size=''>多路分解</font>：

 在接收端， 传输层协议读取报文段中的这些字段， 标识出接收套接字， 进而通过该套接字， 将传输层的报文段中的数据交付给正确的套接字。  

### 2.2. 无连接的多路复用与多路分解  

1. Internet 传输层 提供<font color='red' style='background-color:' size=''>无连接服务</font>的传 输层协议是 <font color='red' style='background-color:' size=''>UDP</font>。 UDP (User Datagram Protocol)： <font color='' style='background-color:#FFFF00' size=''>用户数据报协议</font>。
2. UDP 将应用层的数据块封装成一个 UDP 报文段。 包括应用数据， 源端口号， 目的端口号等。
3. <font color='' style='background-color:#FFFF00' size=''>UDP 套接字二元组:< 目的 IP 地址， 目的端口号 >  </font>

### 2.3. 面向连接的多路复用与多路分解  

1. Internet 传 输 层 提 供 <font color='red' style='background-color:#FFFF00' size=''>面 向 连 接 服 务</font> 的 是 <font color='red' style='background-color:#FFFF00' size=''>TCP </font>。 TCP(Transmission Control Protocol)： <font color='' style='background-color:#FFFF00' size=''>传输控制协议</font>）
2. <font color='' style='background-color:#FFFF00' size=''>TCP 套接字四元组： <源 IP 地址， 源端口号， 目的 IP 地址， 目的端口号>  </font>

## 第三节 停-等协议与滑动窗口协议  

### 3.1. 不可靠传输信道在数据传输中可能发生的错误  

1. <font color='red' style='background-color:' size=''>比特差错</font>： 1001——1000
2. <font color='red' style='background-color:' size=''>乱序</font>： 1001——1010
3. <font color='red' style='background-color:' size=''>数据丢失</font>： 1001——？ ？ ？ ？  

### 3.2. 基于不可靠信道实现可靠数据传输采取的措施

1. <font color='red' style='background-color:' size=''>差错检测</font>： 利用差错编码实现数据包传输过程中的比特差错检测。

2. <font color='red' style='background-color:' size=''>确认</font>： 接收方向发送方反馈接收状态。<font color='' style='background-color:#FFFF00' size=''> ACK</font>（ 肯定确认）； <font color='' style='background-color:#FFFF00' size=''>NAK</font>（ 否定确认）

3. <font color='red' style='background-color:' size=''>重传</font>： 发送方重新发送接收方没有正确接收的数据。

4. <font color='red' style='background-color:' size=''>序号</font>： 确保数据<font color='' style='background-color:#FFFF00' size=''>按序提交</font>。

5. <font color='red' style='background-color:' size=''>计时器</font>： 解决数据丢失问题。

   > 发现在解决，主要是发现（超时器）

### 3.3. 停-等协议  

#### 一、 停-等协议工作原理图：  

> 自动重传请求（ARQ）协议![image-20230403191154434](https://raw.githubusercontent.com/sn-mumu/cloud-storage/main/PicGo/202304031911513.png)

***详细描述：***

1. 发送方发送经过差错编码和编号的报文段， 等待接收方的确认;
2. 接收方差错检测无误且序号正确， 则接收报文段， 并向发送方发送 ACK;否则丢弃报文段，并向发送方发送 NAK;
3. 发送方收到 ACK， 则继续发送后续报文段， 否则重发刚刚发送的报文段。

#### 二、 信道利用率低

停-等协议综合应用了差错检测， 确认， 重传， 序号， 计时器等措施， 简单， 所需缓冲空间小。但是， <font color='red' style='background-color:' size=''>信道利用率低</font>。  

### 3.4. 流水线协议  

> 为了<font color='red' style='background-color:' size=''>解决<font color='' style='background-color:#FFFF00' size=''>信道利用率低</font></font>这个问题， 一个简单的办法是不使用停等协议停止等待运行方式， 允许发送方在没有收到确认前连续发送<font color='' style='background-color:#FFFF00' size=''>多个</font>分组， 这就是流水线协议(<font color='' style='background-color:#FFFF00' size=''>管道协议</font>)。
>
> 发送窗口（W~s~）：发送方 可以发送 未被确认分组的
>
> 最大数量接收窗口（W~r~）：接收方可以缓存的 正确到达 的分组的最大数量

#### 一、 流水线协议实现可靠数据传输需要:

1. 必须增加分组序号;
2. 协议的发送方和接收方必须<font color='' style='background-color:#FFFF00' size=''>缓存</font>多个分组;

#### 二、 <font color='' style='background-color:#FFFF00' size=''>典型</font>的流水线协议： <font color='' style='background-color:#FFFF00' size=''>滑动窗口协议（GBN 协议和 SR 协议  ）</font>。  

> 只用ACK

1. 分组连续编号;
2. 以流水线方式依次发送分组;  
3. 接收方接收分组， 按分组序号向上有序提交;
4. 通过确认向发送方通告正确接收的分组序号;
5. 发送方根据收到的 ACK 的序号以及计时器的， 重新发送或者继续发送新分组。  

***工作流程图 ：***

> ![image-20230403192035851](https://raw.githubusercontent.com/sn-mumu/cloud-storage/main/PicGo/202304031920916.png)
>
> ***发送方：***
>
> 1. 发送窗口 W~s~=5。
> 2. 1、 2、 3、 4（ 发送窗口左侧） 收到 ACK。
> 3. 5、 6、 7、 8、 9（ 发送窗口中） 当前可以发送的。
> 4. 10、 11、 12（ 发送窗口右侧） 当前不可以发送的。  
>
> ***接收方：***
>
> 1. 1、 2、 3、 4、 5、 6（ 接收窗口左侧） 正确接收， 并提交给协议用户的序号。
> 2. 7、 8、 9 期望接收但未收到的。
> 3. 10、 11、 12 暂时不能接收的。  

**GBN 协议和 SR 协议：**

> 滑动窗口协议根据采用的确认、 计时、 窗口大小等机制的不同， 可以设计不同的滑动窗口。 
>
> 两种最具代表的滑动窗口协议：
>
> + 回退 N 步(Go-Back-N,GBN)协议 
> + 选择重传(Selective Repeat,SR)协议  

1. 回退 N 步(Go-Back-N,GBN)协议

   + 发送方<font color='red' style='background-color:' size=''>(W~s~≥1)</font>缓存能力比较高， 可以在未接到确认前连续发送多个分组。
   + 接收方<font color='red' style='background-color:' size=''>(W~r~=1)</font>缓存能力很低， 只能接收一个按序到达的分组， 不能缓存未按序到达的分组。
     未按序到达的分组丢弃， 并让发送方重传。

   > GBN 发送方必须响应 3 个事件:<font color='' style='background-color:#FFFF00' size=''>上层调用</font>； <font color='' style='background-color:#FFFF00' size=''>收到 ACK~n~ (采用累积确认方式)</font>； <font color='' style='background-color:#FFFF00' size=''>计时器超载 (窗口共用一个计时器)</font>

2. 选择重传(Selective Repeat,SR)协议

   + 发送方<font color='red' style='background-color:' size=''>(W~s~≥1)</font>可以在未接到确认前连续发送多个分组。
   + 接收方<font color='red' style='background-color:' size=''>(W~r~≥1)</font>对每个正确接收的分组进行逐个确认。 让发送方仅重传那些未被确认接收
     的分组。

   > SR 发送方主要响应 3 个事件:<font color='' style='background-color:#FFFF00' size=''>上层调用</font>； <font color='' style='background-color:#FFFF00' size=''>计时器超时 (每个分组一个计时器)</font>；  <font color='' style='background-color:#FFFF00' size=''>收到ACK~n~ (逐个分组确认)</font>  

## 第四节 用户数据报协议（ UDP）  

### 4.1. UDP 特点：

#### 一、 用户数据协议(User Datagram Protocol UDP)：

Ineternet 传输层协议， 提供无连接、 不可靠、 数据报尽力传输服务。

1. 应用进程更容易控制发送什么数据以及何时发送， 会出现分组的丢失和重复。
2. 无需建立连接。  
3. 无连接状态。
4. 首部开销小， 只有 8 个字节。  

### 4.2. UDP 数据报结构：  

![image-20230403193347820](https://raw.githubusercontent.com/sn-mumu/cloud-storage/main/PicGo/202304031933882.png)

1. UDP 首部<font color='' style='background-color:#FFFF00' size=''>四个字段</font>， <font color='' style='background-color:#FFFF00' size=''>每个字段</font>长度都是 <font color='' style='background-color:#FFFF00' size=''>2 个字节</font>， 共 8 个字节。
2. <font color='' style='background-color:#FFFF00' size=''>源端口号和目的端口号</font>： 用于 UDP 实现复用和分解
3. <font color='' style='background-color:#FFFF00' size=''>长度</font>： 指示 UDP 报文段中的字节数（ 首部和数据的总和）。
4. <font color='' style='background-color:#FFFF00' size=''>校验和</font>： 接收方使用来检测报文段是否出现差错  

### 4.3. UDP 校验和

#### 一、 UDP 校验和计算规则：

1、 所有参与运算的内容（ 包括 UDP 报文段） <font color='' style='background-color:#FFFF00' size=''>按 <font color='red' style='background-color:' size=''>16 位</font>对齐求和</font>。
2、 求和过程中遇到任何<font color='' style='background-color:#FFFF00' size=''>溢出</font>（ 即进位） 都被<font color='' style='background-color:#FFFF00' size=''>回卷</font>（<font color='' style='background-color:#00FF00' size=''> 即进位与和的最低为再加</font>）， 最后得到的和<font color='red' style='background-color:#FFFF00' size=''>取反码</font>， 就是 UDP 的校验和， 填入 UDP 数据报的校验和字段。
3、 UDP 在生成校验和时， 校验和字段全取 0。

#### 二、 UDP <font color='' style='background-color:#FFFF00' size=''>校验和</font>计算的内容包括 3 部分： <font color='' style='background-color:#FFFF00' size=''>UDP 伪首部 (发送时没有，计算校验和才有)</font>、 <font color='' style='background-color:#FFFF00' size=''>UDP 首部</font>、 <font color='' style='background-color:#FFFF00' size=''>应用数据</font>



1. UDP 伪首部：

   > 源 IP 地址、 目的 IP 地址、 协议号： 均是封装对应 UDP 数据报的 IP 分组的对应字段。  
   >
   > ![image-20230403193822558](https://raw.githubusercontent.com/sn-mumu/cloud-storage/main/PicGo/202304031938630.png)
   >
   > ![](https://raw.githubusercontent.com/william-Run/cloud-storage/main/PicGo/202208241306070.png)

2. UDP 长度字段： 是该 UDP 数据报的字段， 该字段参与计算两次。

3. UDP 协议号： 17。  

























































































































































[^1]: [尚德机构](https://xt.shuhanfenglin.com/) 